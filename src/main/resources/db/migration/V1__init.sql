-- Flyway V1: Initial schema for Oracle
-- Sequences
CREATE SEQUENCE INVESTIMENTO_SEQ START WITH 1 INCREMENT BY 1 NOCACHE NOCYCLE;
CREATE SEQUENCE RENTABILIDADE_DIARIA_SEQ START WITH 1 INCREMENT BY 1 NOCACHE NOCYCLE;

-- Tables
CREATE TABLE USUARIO_INVESTIMENTO (
    ID NUMBER(19) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    CPF_IDENTIFICACAO VARCHAR2(11) NOT NULL UNIQUE
);

CREATE TABLE INVESTIMENTO (
    ID NUMBER(19) PRIMARY KEY,
    NOME_BANCO VARCHAR2(255),
    NOME_INVESTIMENTO VARCHAR2(255) NOT NULL,
    MONTANTE_INICIAL NUMBER(15,2),
    VALOR_INICIAL_ACAO NUMBER(15,2),
    TAXA_RENTABILIDADE NUMBER(10,4),
    NUMERO_ACOES_INICIAL NUMBER(10),
    TIPO_INVESTIMENTO VARCHAR2(50),
    USUARIO_INVESTIMENTO_ID NUMBER(19),
    CONSTRAINT FK_INV_USUARIO FOREIGN KEY (USUARIO_INVESTIMENTO_ID)
        REFERENCES USUARIO_INVESTIMENTO(ID)
);

CREATE TABLE RENTABILIDADE_DIARIA_TABLE (
    ID NUMBER(19) PRIMARY KEY,
    DATA_RENTABILIDADE_DIARIA DATE,
    VALOR_DIARIO_ACAO NUMBER(15,2),
    TAXA_DIARIO_RENTABILIDADE NUMBER(10,4),
    MONTANTE_ACUMULADO_DIARIO NUMBER(15,2),
    INVESTIMENTO_ID NUMBER(19),
    CONSTRAINT FK_RENT_INV FOREIGN KEY (INVESTIMENTO_ID)
        REFERENCES INVESTIMENTO(ID)
);

-- Triggers to emulate sequence usage for PKs where needed
CREATE OR REPLACE TRIGGER BI_INVESTIMENTO
BEFORE INSERT ON INVESTIMENTO
FOR EACH ROW
WHEN (NEW.ID IS NULL)
BEGIN
  SELECT INVESTIMENTO_SEQ.NEXTVAL INTO :NEW.ID FROM DUAL;
END;
/

CREATE OR REPLACE TRIGGER BI_RENTABILIDADE_DIARIA
BEFORE INSERT ON RENTABILIDADE_DIARIA_TABLE
FOR EACH ROW
WHEN (NEW.ID IS NULL)
BEGIN
  SELECT RENTABILIDADE_DIARIA_SEQ.NEXTVAL INTO :NEW.ID FROM DUAL;
END;
/
